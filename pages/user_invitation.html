<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー招待 - セミナーワークシート管理システム</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/monochrome.css">
    <link rel="stylesheet" href="../css/debug.css">
    <style>
        /* モーダル用スタイル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-dialog {
            margin: 0;
            max-width: 90%;
            width: 600px;
        }
        
        .modal-lg {
            max-width: 800px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        body.modal-open {
            overflow: hidden;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .align-center {
            align-items: center;
        }
        
        /* ボタングループ用スタイル */
        .d-flex .btn + .btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">domyaku</div>
                <div class="user-menu">
                    <span>事務局: 山田太郎</span>
                    <a href="instructor_dashboard.html" class="btn btn-outline btn-sm">ダッシュボード</a>
                    <a href="login.html" class="btn btn-secondary btn-sm">ログアウト</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="main-content">
            <nav class="nav">
                <a href="instructor_dashboard.html" class="nav-link">ダッシュボード</a>
                <a href="worksheet_list.html" class="nav-link">ワークシート</a>
                <a href="seminar_list.html" class="nav-link">セミナー</a>
                <a href="user_invitation.html" class="nav-link active">受講者</a>
                <a href="company_registration.html" class="nav-link">会社</a>
            </nav>
            <div class="d-flex justify-between align-center mb-20">
                <h1>受講者一覧</h1>
                <div>
                    <button type="button" class="btn btn-outline btn-sm" data-bs-toggle="modal" data-bs-target="#messageModal">
                        招待メッセージ
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#invitationModal">
                        新規受講者登録
                    </button>
                </div>
            </div>
            
            <!-- 検索・フィルター -->
            <div class="card mb-20">
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 200px 150px; gap: 15px; align-items: end;">
                        <div class="form-group">
                            <label for="search" class="form-label">氏名・会社名で検索</label>
                            <input type="text" id="search" class="form-control" placeholder="氏名・会社名を入力">
                        </div>
                        <div class="form-group">
                            <label for="sort" class="form-label">作成日（新しい順）</label>
                            <select id="sort" class="form-control">
                                <option value="created_desc">作成日（新しい順）</option>
                                <option value="created_asc">作成日（古い順）</option>
                                <option value="name_asc">名前（昇順）</option>
                                <option value="name_desc">名前（降順）</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-outline" onclick="filterWorksheets()">検索</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-between align-center">
                        <div>
                            <h2 class="card-title">ユーザー招待一覧</h2>
                        </div>

                    </div>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>氏名</th>
                                <th>メールアドレス</th>
                                <th>所属会社</th>
                                <th>招待日時</th>
                                <th>ステータス</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="invitationHistory">
                            <tr>
                                <td>田中 一郎</td>
                                <td>participant1@example.com</td>
                                <td>株式会社サンプル</td>
                                <td>2025-08-30 10:30</td>
                                <td><span class="badge badge-success">登録済み</span></td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>佐藤 花子</td>
                                <td>participant2@example.com</td>
                                <td>テスト株式会社</td>
                                <td>2025-08-31 09:15</td>
                                <td><span class="badge badge-warning">招待中</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm" onclick="resendInvitation('participant2@example.com')">再送信</button>
                                    <button class="btn btn-danger btn-sm" onclick="cancelInvitation('participant2@example.com')">取消</button>
                                </td>
                            </tr>
                            <tr>
                                <td>鈴木 次郎</td>
                                <td>instructor1@example.com</td>
                                <td>株式会社サンプル</td>
                                <td>2025-09-01 14:20</td>
                                <td><span class="badge badge-success">登録済み</span></td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ユーザー招待モーダル -->
    <div class="modal fade" id="invitationModal" tabindex="-1" aria-labelledby="invitationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invitationModalLabel">新規ユーザー招待</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="invitationForm" data-validate="true">
                        <div class="form-group">
                            <label for="email" class="form-label">招待するメールアドレス *</label>
                            <input type="email" id="email" name="email" class="form-control" placeholder="例: user@example.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="first_name" class="form-label">姓 *</label>
                            <input type="text" id="first_name" name="first_name" class="form-control" placeholder="例: 山田" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="last_name" class="form-label">名 *</label>
                            <input type="text" id="last_name" name="last_name" class="form-control" placeholder="例: 太郎" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="company_search" class="form-label">所属会社 *</label>
                            <div class="company-search-container">
                                <input type="text" id="company_search" name="company_search" class="form-control" placeholder="会社名を入力して検索..." autocomplete="off">
                                <input type="hidden" id="company_id" name="company_id" required>
                                <div id="company_suggestions" class="company-suggestions"></div>
                            </div>
                            <small class="text-muted">会社名を入力すると候補が表示されます</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="role" class="form-label">権限 *</label>
                            <select id="role" name="role" class="form-control" required>
                                <option value="">権限を選択してください</option>
                                <option value="admin">管理者</option>
                                <option value="user">一般ユーザー</option>
                            </select>
                            <small class="text-muted">管理者：全ての機能にアクセス可能、一般ユーザー：セミナー参加と回答機能のみ</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" form="invitationForm" class="btn btn-primary">招待メールを送信</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 招待メッセージ編集モーダル -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messageModalLabel">招待メッセージの編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="messageForm" data-validate="true">
                        <div class="form-group">
                            <label for="message_template" class="form-label">招待メッセージテンプレート</label>
                            <textarea id="message_template" name="message_template" class="form-control" rows="15">件名: 【動脈株式会社】セミナー管理システムへのご招待

いつもお世話になっております。
動脈株式会社です。

この度、弊社セミナーの事前・事後ワークシートを効率的に管理するため、専用システム「domyaku」をご利用いただくことになりました。

【システムの特徴】
・サインアップ不要（招待URLでパスワード設定のみ）
・セミナー前後のワークシート提出が簡単
・進捗状況の確認が可能

【ご利用開始手順】
1. 下記URLにアクセス
2. パスワードを設定
3. すぐにご利用開始

アクセスURL: [招待URLが自動挿入されます]

セミナーに関してご不明な点がございましたら、お気軽にお問い合わせください。

今後ともよろしくお願いいたします。

動脈株式会社</textarea>
                            <small class="text-muted">
                                このテンプレートは新規ユーザー招待時のデフォルトメッセージとして使用されます。<br>
                                必要に応じて編集し、保存してください。招待URLは自動的に挿入されます。
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" form="messageForm" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <div class="container">
            <p>&copy; 2025 セミナーワークシート管理システム. All rights reserved.</p>
        </div>
    </div>
    
    <style>
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        /* 会社検索用スタイル */
        .company-search-container {
            position: relative;
        }
        
        .company-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .company-suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .company-suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .company-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .company-selected {
            background-color: #e7f3ff;
            border-color: #007bff;
        }
    </style>
    
    <script src="../js/common.js"></script>
    <script>
        // モーダル機能
        document.addEventListener('DOMContentLoaded', function() {
            const modalTriggers = document.querySelectorAll('[data-bs-toggle="modal"]');
            const modals = document.querySelectorAll('.modal');
            const closeButtons = document.querySelectorAll('[data-bs-dismiss="modal"]');
            
            // モーダルを開く
            modalTriggers.forEach(trigger => {
                trigger.addEventListener('click', function() {
                    const targetModal = document.querySelector(this.getAttribute('data-bs-target'));
                    if (targetModal) {
                        targetModal.classList.add('show');
                        document.body.classList.add('modal-open');
                    }
                });
            });
            
            // モーダルを閉じる
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                });
            });
            
            // 背景クリックでモーダルを閉じる
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                        document.body.classList.remove('modal-open');
                    }
                });
            });
            
            // ESCキーでモーダルを閉じる
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        openModal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                    }
                }
            });
        });

        // 会社データ（実際のシステムではAPIから取得）
        const companies = [
            { id: 1, name: '株式会社サンプル' },
            { id: 2, name: 'テスト株式会社' },
            { id: 3, name: 'デモ企業' },
            { id: 4, name: '株式会社テクノロジー' },
            { id: 5, name: 'サンプル商事株式会社' },
            { id: 6, name: 'テストソリューションズ' },
            { id: 7, name: '株式会社イノベーション' }
        ];
        
        // 会社検索機能
        const companySearch = document.getElementById('company_search');
        const companyId = document.getElementById('company_id');
        const suggestions = document.getElementById('company_suggestions');
        
        companySearch.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            
            if (query.length === 0) {
                suggestions.style.display = 'none';
                companyId.value = '';
                companySearch.classList.remove('company-selected');
                return;
            }
            
            const filteredCompanies = companies.filter(company => 
                company.name.toLowerCase().includes(query)
            );
            
            if (filteredCompanies.length > 0) {
                suggestions.innerHTML = filteredCompanies.map(company => 
                    `<div class="company-suggestion-item" data-id="${company.id}" data-name="${company.name}">
                        ${company.name}
                    </div>`
                ).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        });
        
        // 候補選択時の処理
        suggestions.addEventListener('click', function(e) {
            if (e.target.classList.contains('company-suggestion-item')) {
                const selectedId = e.target.getAttribute('data-id');
                const selectedName = e.target.getAttribute('data-name');
                
                companySearch.value = selectedName;
                companyId.value = selectedId;
                companySearch.classList.add('company-selected');
                suggestions.style.display = 'none';
            }
        });
        
        // 外部クリック時に候補を非表示
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.company-search-container')) {
                suggestions.style.display = 'none';
            }
        });
        
        document.getElementById('invitationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (validateForm('invitationForm')) {
                // 会社が選択されているかチェック
                if (!companyId.value) {
                    showError(companySearch, '会社を選択してください');
                    return;
                }
                
                showLoading(this.querySelector('button[type="submit"]'));
                
                // 招待送信処理のシミュレーション
                setTimeout(() => {
                    const email = document.getElementById('email').value;
                    const firstName = document.getElementById('first_name').value;
                    const lastName = document.getElementById('last_name').value;
                    const fullName = `${firstName} ${lastName}`;
                    const companyName = companySearch.value;
                    const role = document.getElementById('role').value;
                    const roleText = role === 'admin' ? '管理者' : '一般ユーザー';
                    
                    // テーブルに新しい行を追加
                    const tbody = document.getElementById('invitationHistory');
                    const newRow = `
                        <tr>
                            <td>${fullName}</td>
                            <td>${email}</td>
                            <td>${companyName}</td>
                            <td>${roleText}</td>
                            <td>${new Date().toLocaleString('ja-JP')}</td>
                            <td><span class="badge badge-warning">招待中</span></td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="resendInvitation('${email}')">再送信</button>
                                <button class="btn btn-danger btn-sm" onclick="cancelInvitation('${email}')">取消</button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('afterbegin', newRow);
                    
                    showAlert(`${fullName} (${companyName}) に招待メールを送信しました`, 'success');
                    
                    // フォームをリセット
                    this.reset();
                    companyId.value = '';
                    companySearch.classList.remove('company-selected');
                    hideLoading(this.querySelector('button[type="submit"]'));
                    
                    // モーダルを閉じる
                    const modal = document.getElementById('invitationModal');
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                }, 2000);
            }
        });
        
        function resendInvitation(email) {
            confirmAction(`${email} に招待メールを再送信しますか？`, () => {
                showAlert(`${email} に招待メールを再送信しました`, 'success');
            });
        }
        
        function cancelInvitation(email) {
            confirmAction(`${email} への招待を取り消しますか？`, () => {
                // 対応する行を削除（メールアドレスは2列目に移動）
                const rows = document.querySelectorAll('#invitationHistory tr');
                rows.forEach(row => {
                    if (row.cells[1] && row.cells[1].textContent === email) {
                        row.remove();
                    }
                });
                showAlert(`${email} への招待を取り消しました`, 'success');
            });
        }
        
        // 招待メッセージ管理
        let messageTemplate = `件名: 【動脈株式会社】セミナー管理システムへのご招待

いつもお世話になっております。
動脈株式会社です。

この度、弊社セミナーの事前・事後ワークシートを効率的に管理するため、専用システム「domyaku」をご利用いただくことになりました。

【システムの特徴】
・サインアップ不要（招待URLでパスワード設定のみ）
・セミナー前後のワークシート提出が簡単
・進捗状況の確認が可能

【ご利用開始手順】
1. 下記URLにアクセス
2. パスワードを設定
3. すぐにご利用開始

アクセスURL: [招待URLが自動挿入されます]

セミナーに関してご不明な点がございましたら、お気軽にお問い合わせください。

今後ともよろしくお願いいたします。

動脈株式会社`;
        
        // 招待メッセージフォームの送信処理
        document.getElementById('messageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newTemplate = document.getElementById('message_template').value;
            messageTemplate = newTemplate;
            
            showAlert('招待メッセージテンプレートを保存しました', 'success');
            
            // モーダルを閉じる
            const modal = document.getElementById('messageModal');
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        });
        
        // デフォルトメッセージに戻す
        function resetMessageTemplate() {
            confirmAction('招待メッセージをデフォルトに戻しますか？', () => {
                const defaultTemplate = `件名: 【動脈株式会社】セミナー管理システムへのご招待

いつもお世話になっております。
動脈株式会社です。

この度、弊社セミナーの事前・事後ワークシートを効率的に管理するため、専用システム「domyaku」をご利用いただくことになりました。

【システムの特徴】
・サインアップ不要（招待URLでパスワード設定のみ）
・セミナー前後のワークシート提出が簡単
・進捗状況の確認が可能

【ご利用開始手順】
1. 下記URLにアクセス
2. パスワードを設定
3. すぐにご利用開始

アクセスURL: [招待URLが自動挿入されます]

セミナーに関してご不明な点がございましたら、お気軽にお問い合わせください。

今後ともよろしくお願いいたします。

動脈株式会社`;
                
                document.getElementById('message_template').value = defaultTemplate;
                showAlert('デフォルトメッセージに戻しました', 'success');
            });
        }
        
        // 招待フォームが開かれた時の処理
        document.querySelector('[data-bs-target="#invitationModal"]').addEventListener('click', function() {
            // 必要に応じて処理を追加
        });
    </script>
</body>
</html>



